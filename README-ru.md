### ParanoidBackup v1.0
https://github.com/LineEditor/ParanoidBackup

# О проекте

ParanoidBackup - система резервного копирования с открытым исходным кодом, написанная на языке PHP. 
Для её работы нужно установить PHP версии 7.0 или выше.  

# Возможности системы 
- Копирование файлов из таких источников как локальный каталог, FTP, SFTP (SSH File Transfer Protocol), Яндекс.диск и последующее
копирование сохранённых резервных копий на неограниченное количество хранилищ, поддерживающих указанные протоколы.
- Инкрементальный бэкап. При первом запуске в текущий день создаётся каталог с названием, равным текущей дате в формате ГГГГ-ММ-ДД
  и в этот каталог добавляются только новые файлы и файлы, изменные после запуска в предыдущий день.
- Возможность игнорировать файлы в источнике путём указания каталога, где они размещаются, и/или их расширения  
- Ротация каталогов, хранящих версии резервных файлов, с заданной периодичностью 

# Начало работы
- Создайте в папке conf каталог с названием вашего проекта (один проект - один каталог в conf).
- Скопируйте в него файл backup.ini из conf/example. Удалите каталог conf/example, или выставьте в conf/example/backup.ini enabled=0   
- Укажите в backup.ini все необходимые настройки. Все необходимые пояснения в этом файле имеются
- Запустите скрипт командой *php pbackup.php* или командой php pbackup.php -p=<ваш_каталог_в_папке_conf>, если вы хотите, чтобы
  был создан бэкап только для этого проекта.
 

# Работа ParanoidBackup   
  При самом первом запуске в каталоге backup_dir, указанном в backup.ini, создаётся  каталог base, куда копируются все файлы из remote_dir. 
  Если повторно в этот же день запустить ParanoidBackup, то в base повторно целиком скопируются все файлы.
  Таким образом base - это основной каталог, где хранятся все файлы, которые были в проекте на момент первого запуска ParanoidBackup.
   
    
  Если каталог base уже существует, а дата запуска ParanoidBackup отличается от даты создания каталога base, то **создаётся
  каталог формата YYYY-mm-dd**, и в него копируются только новые или изменённые файлы из remote_dir.
  Таким образом,  каждый новый день запуска ParanoidBackup создаёт новый каталог, название которого равно дате запуска в формате
  YYYY-mm-dd, и этот каталог содержит только новые или изменённые файлы. **Если никаких новых или изменённых файлов нет, то каталог
  не создаётся**.
   
  
  Если заполнена секция [afterbackup], то после того, как файлы скопированы в каталог бэкапа, они будут отправлены в хранилища, указанные в этой секции.
  
  То есть возможен такой сценарий:
  Скачали файлы с FTP к себе на компьютер или на бэкап сервер, и после этого отправили на другой FTP или на Яндекс-диск, 
  или в ещё один каталог на том же сервере. Если в настройках соединения параметр m указан равным трём, то файлы будут закачаны на приёмник
  в виде zip-архива. Если указан пароль zippassword - то архив будет закрыт этим паролем. 
  

  Все каталоги, которые старше, чем дата текущего запуска ParanoidBackup минус rotate_days (указываются всё там же в backup.ini), будут
  удалены, а их содержимое будет скопировано в base, с заменой файлов. Таким образом, в base хранятся версии файлов, созданные до
  *текущая дата минус rotate_days*, а каталогах с имененем ГГГГ-ММ-ДД - всё, что создано после *текущая дата минус rotate_days* 
  
# Создание полного бэкапа  

Чтобы получить все свежие версии файлов в каталоге base без удаления каталогов ГГГГ-ММ-ДД, запустите команду   

php pbackup.php -c=cfb 

возможные дополнительные параметры

-p  - названия проектов (каталогов) из папки conf, которые будут обрабатываться, через запятую.
Если не задано, то обрабатываются все

-d - дата, до которой будут учитываться каталоги бэкапа, названные по датам. 
Например, если у нас есть каталоги

base
2022-01-10
2022-01-15
2022-01-16
2022-01-18
2022-01-20

то команда
php pbackup.php -c=cfb -p=site.ru -d=2022-01-16

создаст полный бэкап  проекта site.ru, будут учтены каталоги 2022-01-10, 2022-01-15, 2022-01-16, а каталоги
2022-01-18 и 2022-01-20 учтены не будут.

Таким образом, в base не будет файлов, дата создания которых новее чем 2022-01-16 

### Примеры
Если вы хотите, чтобы также был создан архив с этими файлами:

* Для создания архива в каталоге проекта c именем имяпроекта_ГГГГ_ММ_ДД.zip:

  php pbackup.php -c=cfb -p=site.ru -zip

* Для создания архива в каталоге проекта c заданным именем
  
  php pbackup.php -c=cfb -p=site.ru -zip=myname.zip

* Для создания архива в заданном каталоге c заданным именем
  
  php pbackup.php -c=cfb -p=site.ru -zip=myname.zip -dir=c:/backup
  
* Для создания архива в заданном каталоге c заданным именем и с паролем
  
  php pbackup.php -c=cfb -p=site.ru -zip=myname.zip -zippassw=12345 -dir=c:/backup
  
## Другие варианты запуска ParanoidBackup

* Показать версию программы:

  php pbackup.php -v 

* Вызов справки: 

  php pbackup.php -h 
 

Если по каким-то причинам вы не хотите запускать ParanoidBackup в стандартном режиме с отработкой
всех сценариев, прописанных в backup.ini, то можно запустить его в режиме, позволяющем выполнить только часть из этого сценария.

### Загрузка каталогов бэкапа в хранилища, прописанные в секции afterbackup

php pbackup.php -c=upl [-all] [-p=<список проектов>]

Возможные параметры:

-all - копировать все каталоги, включая base

**Если параметр -all не задан:**

В этом случае копируются только те каталоги, которых нет в хранилище.

При этом файлы из последнего каталога с бэкапом загружаются всегда, даже если такой каталог уже есть в хранилище.

Предположим, ваши действия следующие:
- Вы запускали сегодня скрипт бэкапа, он создал каталог, имя которого равно текущей дате -
например 2022-01-22 
- После этого выполнили команду  *php pbackup.php -c=upl*
- В этот же день опять запустили ParanoidBackup в режиме бэкапа, и он добавил новые файлы в каталог 2022-01-22
- В этот же день опять запустили *php pbackup.php -c=upl* -  все файлы из каталога 2022-01-22 будут загружены в хранилище.

Другой вариант:
- Сегодня 2022-01-21, у вас есть каталог бэкапа 2022-01-21 и вы загрузили его в хранилище 
- После этого опять запустили ParanoidBackup в обычном режиме и у вас в каталоге 2022-01-21 появились новые файлы
- Настал следующий день -  2022-01-22, у вас создался каталог 2022-01-22 с новыми файлами.
- Вы запускаете *php pbackup.php -c=upl* - в этом случае новые файлы из предыдущего каталога 2022-01-21 загружены на сервер не будут, 
  будут загружены только файлы из 2022-01-22

## Ротация каталогов в удалённом хранилище

Если вы хотите произвести принудительную ротацию каталогов в удалённом хранилище, согласно конфигу в блоке [afterbackup],
то надо выполнить следующую команду:

php pbackup.php -c=rotr -p=<список проектов> -conn=<номера коннекторов через запятую без пробела>

Здесь под коннекторами имеются ввиду настройки соединений в переменных after_1, after_2 и и т.д.


У каждого коннектора есть параметр rd - это то, какое количество дней будут хранится каталоги. По истечении этого числа дней
каталоги, чей возраст уже больше числа дней из параметра rd удаляются, и файлы из них переносится в /base.

Пример. 

Сегодня 2022-01-23.

У нас есть каталоги бэкапа со следующими именами:

2022-01-10, 2022-01-12, 2022-01-13, 2022-01-14, 2022-01-15, 2022-01-16, 2022-01-18, 2022-01-20, 2022-01-22

Параметр rd = 5. То есть, раз сегодня 23 число, то мы оставляем только каталоги, которые созданы от 18 числа и позже.

Значит при ротации останутся каталоги  2022-01-18, 2022-01-20, 2022-01-22, а остальные будут удалены, а файлы из них перенесена в base

## Ротация zip-файлов в удалённом хранилище

php pbackup.php -c=rotr_zip -p=<список проектов> -conn=<номера коннекторов через запятую без пробела>

Эта операция во временном каталоге создаёт копию каталога backup_dir, внутри этого временного каталога проводит ротацию файлов
(копирование файлов, чей возраст больше заданного, из каталогов ГГГГ-ММ-ДД в каталог base), создание архива, содержащего каталог
base, и загрузка этого архива в удалённое хранилище. Предварительно в удалённом хранилище удаляются zip-архивы, содержащие каталоги
ГГГГ-ММ-ДД, чей возраст больше чем текущая дата минус число дней, указанное в параметре  rd коннектора.   
